ARG FEDORA_VERSION=latest

FROM registry.fedoraproject.org/fedora:$FEDORA_VERSION
ARG SUNSHINE_VERSION=0.20.0

RUN set -x \
  \
  && dnf install -y \
    https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
    https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm \
  && dnf install -y --setopt=install_weak_deps=False --best \
    git-core \
    mesa-dri-drivers \
    # mesa-va-drivers-freeworld \
    # mesa-vdpau-drivers-freeworld \
    # https://koji.rpmfusion.org/koji/packageinfo?packageID=650
    https://koji.rpmfusion.org/kojifiles/packages/mesa-freeworld/23.1.6/1.fc38/x86_64/mesa-va-drivers-freeworld-23.1.6-1.fc38.x86_64.rpm \
    https://koji.rpmfusion.org/kojifiles/packages/mesa-freeworld/23.1.6/1.fc38/x86_64/mesa-vdpau-drivers-freeworld-23.1.6-1.fc38.x86_64.rpm \
    xorg-x11-drv-nvidia-libs \
    xorg-x11-drv-nvidia-cuda-libs \
    https://github.com/LizardByte/Sunshine/releases/download/v$SUNSHINE_VERSION/sunshine-fedora-$(rpm -E %fedora)-amd64.rpm \
  \
  && dnf autoremove -y \
  && dnf clean all \
  && rm -rf /var/cache /var/log/dnf* /var/log/yum.* \
  \
  # patch nvidia driver
  && git clone https://github.com/keylase/nvidia-patch.git nvidia-patch \
  # patch script forces check on nvidia-smi even if we are specifying a driver version
  # this is a hack to bypass it
  && touch /usr/bin/nvidia-smi \
  && ./nvidia-patch/patch.sh -d $(rpm -q --queryformat "%{VERSION}" xorg-x11-drv-nvidia-cuda-libs) \
  && ./nvidia-patch/patch-fbc.sh -d $(rpm -q --queryformat "%{VERSION}" xorg-x11-drv-nvidia-cuda-libs) \
  && rm -r \
    /usr/bin/nvidia-smi\
    nvidia-patch \
    /opt/nvidia

COPY apps.json /root/.config/sunshine/apps.json

ENTRYPOINT ["sunshine"]