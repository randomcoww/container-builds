ARG FEDORA_VERSION=39

FROM registry.fedoraproject.org/fedora-minimal:$FEDORA_VERSION
ARG VERSION
ARG DRIVER_VERSION
ARG TARGETARCH

COPY custom.repo /etc/yum.repos.d/

RUN set -x \
  \
  && echo 'exclude=*.i386 *.i686' >> /etc/dnf.conf \
  && microdnf install -y \
    https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
    https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm \
  \
  && microdnf install -y --setopt=install_weak_deps=False --best \
    kmod-nvidia-open-dkms-$DRIVER_VERSION \
    nvidia-driver-$DRIVER_VERSION \
    nvidia-driver-cuda-libs-$DRIVER_VERSION \
    nvidia-modprobe-$DRIVER_VERSION \
    libnvidia-fbc-$DRIVER_VERSION \
    libva-nvidia-driver \
    https://github.com/LizardByte/Sunshine/releases/download/v$VERSION/sunshine-fedora-$(rpm -E %fedora)-$TARGETARCH.rpm \
  \
  && microdnf clean all \
  && rm -rf \
    /var/cache \
    /var/log/*

ENV \
  NVIDIA_VISIBLE_DEVICES=all \
  NVIDIA_DRIVER_CAPABILITIES=all

ENTRYPOINT ["sunshine"]