ARG FEDORA_VERSION=39

FROM registry.fedoraproject.org/fedora:$FEDORA_VERSION
ARG VERSION
ARG TARGETARCH

COPY custom.repo /etc/yum.repos.d/

RUN set -x \
  \
  && echo 'exclude=*.i386 *.i686' >> /etc/dnf.conf \
  && dnf install -y \
    https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
    https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm \
  \
  && dnf install -y --setopt=install_weak_deps=False --best \
    git-core \
    kmod-nvidia-open-dkms \
    nvidia-driver \
    nvidia-driver-cuda \
    nvidia-vaapi-driver \
    libnvidia-fbc \
    https://github.com/LizardByte/Sunshine/releases/download/v$VERSION/sunshine-fedora-$(rpm -E %fedora)-$TARGETARCH.rpm \
  \
  && git clone https://github.com/keylase/nvidia-patch.git nvidia-patch \
  && ./nvidia-patch/patch.sh -d $(rpm -q --queryformat "%{VERSION}" nvidia-driver) \
  && ./nvidia-patch/patch-fbc.sh -d $(rpm -q --queryformat "%{VERSION}" nvidia-driver) \
  \
  && dnf remove -y \
    git-core \
  && dnf autoremove -y \
  && dnf clean all \
  && rm -rf /var/cache /var/log/dnf* /var/log/yum.* nvidia-patch /opt/nvidia

ENTRYPOINT ["sunshine"]