FROM docker.io/node:slim
ARG VERSION

ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
ENV NODE_ENV=production

WORKDIR /app

RUN set -x \
  \
  && npm install patchright@$VERSION \
  && npx -y patchright install-deps \
    chromium \
  \
  && npm cache clean --force \
  && mkdir -p ${PLAYWRIGHT_BROWSERS_PATH} \
  && chown -R node:node . ${PLAYWRIGHT_BROWSERS_PATH} \
  \
  && apt clean \
  && rm -rf /var/lib/apt/lists/*

USER node
RUN set -x \
  \
  && npx -y patchright install \
    chromium