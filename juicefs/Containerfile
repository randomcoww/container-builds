FROM docker.io/alpine:latest AS build
ARG RELEASE
ARG INTERNAL_CA_CERT

RUN set -x \
  \
  && TARGETARCH=$(arch) \
  && TARGETARCH=${TARGETARCH/x86_64/amd64} && TARGETARCH=${TARGETARCH/aarch64/arm64} \
  \
  && apk add --no-cache \
    ca-certificates \
  \
  && wget -O jfs.tar.gz \
    https://github.com/juicedata/juicefs/releases/download/$RELEASE/juicefs-$(echo $RELEASE | tr -d 'v')-linux-$TARGETARCH.tar.gz \
  && tar xzf jfs.tar.gz -C /usr/local/bin juicefs \
  && rm jfs.tar.gz \
  && echo -e "$INTERNAL_CA_CERT" > /usr/local/share/ca-certificates/ca-cert.pem \
  && update-ca-certificates

FROM scratch

COPY --from=build /usr/local/bin/juicefs /bin/
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

ENV SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt

ENTRYPOINT ["/bin/juicefs"]