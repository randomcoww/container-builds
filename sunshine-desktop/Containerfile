# based on https://github.com/linuxserver/docker-baseimage-kasmvnc/blob/fedora38/Dockerfile
ARG FEDORA_VERSION=38

FROM ghcr.io/linuxserver/baseimage-fedora:$FEDORA_VERSION AS BASE
ARG SUNSHINE_VERSION=0.20.0
ARG USER=podman

ENV \
HOME=/config \
XDG_RUNTIME_DIR=/run/$USER \
PULSE_RUNTIME_PATH=/run/$USER

COPY containers.conf /etc/containers/containers.conf

RUN set -x \
  \
  && userdel -rf abc \
  \
  && rpm --setcaps shadow-utils 2>/dev/null \
  && dnf install -y \
    https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm \
  && dnf install -y --setopt=install_weak_deps=False --best \
    ca-certificates \
    git-core \
    iproute-tc \
    iptables-nft \
    gzip \
    tar \
    xz \
    jq \
    procps-ng \
    which \
    lsof \
    ldns-utils \
    sudo \
    vim-minimal \
    less \
    clinfo \
    mesa-dri-drivers \
    mesa-libgbm \
    mesa-libGL \
    mesa-libOpenCL \
    mesa-va-drivers-freeworld \
    mesa-vdpau-drivers-freeworld \
    libva-utils \
    vulkan \
    vulkan-tools \
    libva-vdpau-driver \
    vdpauinfo \
    openssh-clients \
    pulseaudio \
    pulseaudio-utils \
    util-linux \
    flatpak \
    sway \
    foot \
    kbd \
    xkbcomp \
    setxkbmap \
    seatd \
    https://github.com/LizardByte/Sunshine/releases/download/v$SUNSHINE_VERSION/sunshine-fedora-$(rpm -E %fedora)-amd64.rpm \
  --exclude \
    container-selinux \
  \
  && dnf autoremove -y \
  && dnf clean all \
  && rm -rf /var/cache /var/log/dnf* /var/log/yum.* \
  && useradd $USER -m -u 1000 \
  && mkdir -p \
    $XDG_RUNTIME_DIR \
    $PULSE_RUNTIME_PATH \
    $HOME \
  && chown $USER:$USER -R \
    $XDG_RUNTIME_DIR \
    $PULSE_RUNTIME_PATH \
    $HOME \
  && usermod -G wheel,input $USER \
  && echo '%wheel ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/wheel

# Don't allow changing UID/GID
RUN find /etc/s6-overlay -type f -name init-adduser -exec rm {} \;

COPY /root /
RUN find /etc/s6-overlay -type f -exec sed -i -e "s/abc/$USER/g" {} \;

ENV \
TERM=foot \
DESKTOP_SESSION=sway \
XDG_SESSION_TYPE=wayland \
XDG_CURRENT_DESKTOP=sway \
XDG_SESSION_DESKTOP=sway \
WAYLAND_DISPLAY=wayland-1 \
WLR_BACKENDS=headless,libinput \
WLR_NO_HARDWARE_CURSORS=1 \
_CONTAINERS_USERNS_CONFIGURED=""
